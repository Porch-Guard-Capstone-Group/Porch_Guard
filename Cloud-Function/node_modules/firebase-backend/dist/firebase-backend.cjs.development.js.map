{"version":3,"file":"firebase-backend.cjs.development.js","sources":["../src/models.ts","../src/functionParser.ts"],"sourcesContent":["// models.ts\r\n\r\n/**\r\n * @export\r\n * @enum {number}\r\n */\r\nexport enum RequestType {\r\n  GET = 'GET',\r\n  POST = 'POST',\r\n  PUT = 'PUT',\r\n  DELETE = 'DELETE',\r\n  PATCH = 'PATCH',\r\n}\r\n\r\n/**\r\n * @export\r\n * @interface IExpressHandler\r\n */\r\nexport interface IExpressHandler {\r\n  (req: any, res: any): any;\r\n}\r\n\r\n/**\r\n * Stores the information to be used when creating a restful endpoint on the backend\r\n *\r\n * @export\r\n * @class Endpoint\r\n */\r\nexport class Endpoint {\r\n  /**\r\n   * Creates an instance of Endpoint.\r\n   *\r\n   * @param {string} name\r\n   * @param {RequestType} requestType\r\n   * @param {IExpressHandler} handler\r\n   * @memberof Endpoint\r\n   */\r\n  constructor(\r\n    /**\r\n     * @deprecated \"name\" parameter is no longer needed\r\n     */\r\n    public name: string | undefined,\r\n    public requestType: RequestType,\r\n    public handler: IExpressHandler,\r\n  ) {\r\n    if (!handler) {\r\n      throw new Error('Please provide a endpoint request handler.');\r\n    }\r\n\r\n    this.name = name;\r\n    this.handler = handler;\r\n    this.requestType = requestType;\r\n  }\r\n}\r\n\r\nexport class Get extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.GET, handler);\r\n  }\r\n}\r\nexport class Post extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.POST, handler);\r\n  }\r\n}\r\nexport class Put extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.PUT, handler);\r\n  }\r\n}\r\nexport class Delete extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.DELETE, handler);\r\n  }\r\n}\r\nexport class Patch extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.PATCH, handler);\r\n  }\r\n}\r\n","// functionParser.ts\r\n\r\nimport express, { Application, Router } from 'express';\r\nimport * as functions from 'firebase-functions';\r\nimport glob from 'glob';\r\nimport { parse, ParsedPath } from 'path';\r\nimport { Endpoint, RequestType } from './models';\r\n\r\n// enable short hand for console.log()\r\nconst { log } = console;\r\n\r\n/**\r\n * This class helps with setting sup the exports for the cloud functions deployment.\r\n *\r\n * It takes in exports and then adds the required groups and their functions to it for deployment\r\n * to the cloud functions server.\r\n *\r\n * @export\r\n * @class FunctionParser\r\n */\r\nexport class FunctionParser {\r\n  rootPath: string;\r\n\r\n  exports: any;\r\n\r\n  /**\r\n   * Creates an instance of FunctionParser.\r\n   *\r\n   * @param {string} rootPath\r\n   * @param {*} exports\r\n   * @param {boolean} [buildReactive=true]\r\n   * @param {boolean} [buildEndpoints=true]\r\n   * @param {boolean} [groupByFolder=true]\r\n   * @memberof FunctionParser\r\n   */\r\n  constructor(\r\n    rootPath: string,\r\n    exports: any,\r\n    buildReactive: boolean = true,\r\n    buildEndpoints: boolean = true,\r\n    groupByFolder: boolean = true,\r\n  ) {\r\n    if (!rootPath) {\r\n      throw new Error('rootPath is required to find the functions.');\r\n    }\r\n\r\n    this.rootPath = rootPath;\r\n    this.exports = exports;\r\n\r\n    if (buildReactive) {\r\n      this.buildReactiveFunctions(groupByFolder);\r\n    }\r\n\r\n    if (buildEndpoints) {\r\n      this.buildRestfulApi(groupByFolder);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Looks for all files with .function.js and exports them on the group they belong to\r\n   *\r\n   * @private\r\n   * @param {boolean} groupByFolder\r\n   * @memberof FunctionParser\r\n   */\r\n  private buildReactiveFunctions(groupByFolder: boolean) {\r\n    log('Reactive Functions - Building...');\r\n\r\n    // Get all the files that has .function in the file name\r\n    const functionFiles: string[] = glob.sync(\r\n      `${this.rootPath}/**/*.function.js`,\r\n      {\r\n        cwd: this.rootPath,\r\n        ignore: './node_modules/**',\r\n      },\r\n    );\r\n\r\n    functionFiles.forEach((file: string) => {\r\n      const filePath: ParsedPath = parse(file);\r\n\r\n      const directories: string[] = filePath.dir.split('/');\r\n\r\n      const groupName: string = groupByFolder\r\n        ? directories[directories.length - 2] || ''\r\n        : directories[directories.length - 1] || '';\r\n\r\n      const functionName = filePath.name.replace('.function', '');\r\n\r\n      if (\r\n        !process.env.FUNCTION_NAME ||\r\n        process.env.FUNCTION_NAME === functionName\r\n      ) {\r\n        if (!this.exports[groupName]) this.exports[groupName] = {};\r\n        log(`Reactive Functions - Added ${groupName}/${functionName}`);\r\n\r\n        this.exports[groupName] = {\r\n          ...this.exports[groupName],\r\n          ...require(file),\r\n        };\r\n      }\r\n    });\r\n\r\n    log('Reactive Functions - Built');\r\n  }\r\n\r\n  /**\r\n   * Looks at all .endpoint.js files and adds them to the group they belong in\r\n   *\r\n   * @private\r\n   * @param {boolean} groupByFolder\r\n   * @memberof FunctionParser\r\n   */\r\n  private buildRestfulApi(groupByFolder: boolean) {\r\n    log('Restful Endpoints - Building...');\r\n\r\n    const apiFiles: string[] = glob.sync(`${this.rootPath}/**/*.endpoint.js`, {\r\n      cwd: this.rootPath,\r\n      ignore: './node_modules/**',\r\n    });\r\n\r\n    const app: Application = express();\r\n\r\n    const groupRouters: Map<string, express.Router> = new Map();\r\n\r\n    apiFiles.forEach((file: string) => {\r\n      const filePath: ParsedPath = parse(file);\r\n\r\n      const directories: Array<string> = filePath.dir.split('/');\r\n\r\n      const groupName: string = groupByFolder\r\n        ? directories[directories.length - 2] || ''\r\n        : directories[directories.length - 1] || '';\r\n\r\n      let router: Router | undefined = groupRouters.get(groupName);\r\n\r\n      if (!router) {\r\n        router = express.Router();\r\n\r\n        groupRouters.set(groupName, router);\r\n      }\r\n\r\n      try {\r\n        this.buildEndpoint(file, groupName, router);\r\n      } catch (e) {\r\n        throw new Error(\r\n          `Restful Endpoints - Failed to add the endpoint defined in ${file} to the ${groupName} Api.`,\r\n        );\r\n      }\r\n\r\n      app.use('/', router);\r\n\r\n      this.exports[groupName] = {\r\n        ...this.exports[groupName],\r\n        api: functions.https.onRequest(app),\r\n      };\r\n    });\r\n\r\n    log('Restful Endpoints - Built');\r\n  }\r\n\r\n  /**\r\n   * Parses a .endpoint.js file and sets the endpoint path on the provided router\r\n   *\r\n   * @private\r\n   * @param {string} file\r\n   * @param {express.Router} router\r\n   * @memberof FunctionParser\r\n   */\r\n  private buildEndpoint(\r\n    file: string,\r\n    groupName: string,\r\n    router: express.Router,\r\n  ) {\r\n    const filePath: ParsedPath = parse(file);\r\n\r\n    const endpoint: Endpoint = require(file).default as Endpoint;\r\n\r\n    const name: string =\r\n      endpoint.name || filePath.name.replace('.endpoint', '');\r\n\r\n    const { handler } = endpoint;\r\n\r\n    switch (endpoint.requestType) {\r\n      case RequestType.GET:\r\n        router.get(`/${name}`, handler);\r\n        break;\r\n\r\n      case RequestType.POST:\r\n        router.post(`/${name}`, handler);\r\n        break;\r\n\r\n      case RequestType.PUT:\r\n        router.put(`/${name}`, handler);\r\n        break;\r\n\r\n      case RequestType.DELETE:\r\n        router.delete(`/${name}`, handler);\r\n        break;\r\n\r\n      case RequestType.PATCH:\r\n        router.patch(`/${name}`, handler);\r\n        break;\r\n\r\n      default:\r\n        throw new Error(\r\n          `A unsupported RequestType was defined for a Endpoint.\\n\r\n          Please make sure that the Endpoint file exports a RequestType\r\n          using the constants in src/system/constants/requests.ts.\\n\r\n          **This value is required to add the Endpoint to the API**`,\r\n        );\r\n    }\r\n    log(\r\n      `Restful Endpoints - Added ${groupName}/${endpoint.requestType}:${name}`,\r\n    );\r\n  }\r\n}\r\n"],"names":["RequestType","Endpoint","name","requestType","handler","Error","Get","undefined","GET","Post","POST","Put","PUT","Delete","DELETE","Patch","PATCH","console","log","FunctionParser","rootPath","exports","buildReactive","buildEndpoints","groupByFolder","buildReactiveFunctions","buildRestfulApi","functionFiles","glob","sync","cwd","ignore","forEach","file","filePath","parse","directories","dir","split","groupName","length","functionName","replace","process","env","FUNCTION_NAME","require","apiFiles","app","express","groupRouters","Map","router","get","Router","set","buildEndpoint","e","use","api","functions","onRequest","endpoint","post","put","patch"],"mappings":"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"}