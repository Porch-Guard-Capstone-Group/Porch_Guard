{"version":3,"file":"firebase-backend.cjs.production.min.js","sources":["../src/models.ts","../src/functionParser.ts"],"sourcesContent":["// models.ts\r\n\r\n/**\r\n * @export\r\n * @enum {number}\r\n */\r\nexport enum RequestType {\r\n  GET = 'GET',\r\n  POST = 'POST',\r\n  PUT = 'PUT',\r\n  DELETE = 'DELETE',\r\n  PATCH = 'PATCH',\r\n}\r\n\r\n/**\r\n * @export\r\n * @interface IExpressHandler\r\n */\r\nexport interface IExpressHandler {\r\n  (req: any, res: any): any;\r\n}\r\n\r\n/**\r\n * Stores the information to be used when creating a restful endpoint on the backend\r\n *\r\n * @export\r\n * @class Endpoint\r\n */\r\nexport class Endpoint {\r\n  /**\r\n   * Creates an instance of Endpoint.\r\n   *\r\n   * @param {string} name\r\n   * @param {RequestType} requestType\r\n   * @param {IExpressHandler} handler\r\n   * @memberof Endpoint\r\n   */\r\n  constructor(\r\n    /**\r\n     * @deprecated \"name\" parameter is no longer needed\r\n     */\r\n    public name: string | undefined,\r\n    public requestType: RequestType,\r\n    public handler: IExpressHandler,\r\n  ) {\r\n    if (!handler) {\r\n      throw new Error('Please provide a endpoint request handler.');\r\n    }\r\n\r\n    this.name = name;\r\n    this.handler = handler;\r\n    this.requestType = requestType;\r\n  }\r\n}\r\n\r\nexport class Get extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.GET, handler);\r\n  }\r\n}\r\nexport class Post extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.POST, handler);\r\n  }\r\n}\r\nexport class Put extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.PUT, handler);\r\n  }\r\n}\r\nexport class Delete extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.DELETE, handler);\r\n  }\r\n}\r\nexport class Patch extends Endpoint {\r\n  constructor(handler: IExpressHandler) {\r\n    super(undefined, RequestType.PATCH, handler);\r\n  }\r\n}\r\n","// functionParser.ts\r\n\r\nimport express, { Application, Router } from 'express';\r\nimport * as functions from 'firebase-functions';\r\nimport glob from 'glob';\r\nimport { parse, ParsedPath } from 'path';\r\nimport { Endpoint, RequestType } from './models';\r\n\r\n// enable short hand for console.log()\r\nconst { log } = console;\r\n\r\n/**\r\n * This class helps with setting sup the exports for the cloud functions deployment.\r\n *\r\n * It takes in exports and then adds the required groups and their functions to it for deployment\r\n * to the cloud functions server.\r\n *\r\n * @export\r\n * @class FunctionParser\r\n */\r\nexport class FunctionParser {\r\n  rootPath: string;\r\n\r\n  exports: any;\r\n\r\n  /**\r\n   * Creates an instance of FunctionParser.\r\n   *\r\n   * @param {string} rootPath\r\n   * @param {*} exports\r\n   * @param {boolean} [buildReactive=true]\r\n   * @param {boolean} [buildEndpoints=true]\r\n   * @param {boolean} [groupByFolder=true]\r\n   * @memberof FunctionParser\r\n   */\r\n  constructor(\r\n    rootPath: string,\r\n    exports: any,\r\n    buildReactive: boolean = true,\r\n    buildEndpoints: boolean = true,\r\n    groupByFolder: boolean = true,\r\n  ) {\r\n    if (!rootPath) {\r\n      throw new Error('rootPath is required to find the functions.');\r\n    }\r\n\r\n    this.rootPath = rootPath;\r\n    this.exports = exports;\r\n\r\n    if (buildReactive) {\r\n      this.buildReactiveFunctions(groupByFolder);\r\n    }\r\n\r\n    if (buildEndpoints) {\r\n      this.buildRestfulApi(groupByFolder);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Looks for all files with .function.js and exports them on the group they belong to\r\n   *\r\n   * @private\r\n   * @param {boolean} groupByFolder\r\n   * @memberof FunctionParser\r\n   */\r\n  private buildReactiveFunctions(groupByFolder: boolean) {\r\n    log('Reactive Functions - Building...');\r\n\r\n    // Get all the files that has .function in the file name\r\n    const functionFiles: string[] = glob.sync(\r\n      `${this.rootPath}/**/*.function.js`,\r\n      {\r\n        cwd: this.rootPath,\r\n        ignore: './node_modules/**',\r\n      },\r\n    );\r\n\r\n    functionFiles.forEach((file: string) => {\r\n      const filePath: ParsedPath = parse(file);\r\n\r\n      const directories: string[] = filePath.dir.split('/');\r\n\r\n      const groupName: string = groupByFolder\r\n        ? directories[directories.length - 2] || ''\r\n        : directories[directories.length - 1] || '';\r\n\r\n      const functionName = filePath.name.replace('.function', '');\r\n\r\n      if (\r\n        !process.env.FUNCTION_NAME ||\r\n        process.env.FUNCTION_NAME === functionName\r\n      ) {\r\n        if (!this.exports[groupName]) this.exports[groupName] = {};\r\n        log(`Reactive Functions - Added ${groupName}/${functionName}`);\r\n\r\n        this.exports[groupName] = {\r\n          ...this.exports[groupName],\r\n          ...require(file),\r\n        };\r\n      }\r\n    });\r\n\r\n    log('Reactive Functions - Built');\r\n  }\r\n\r\n  /**\r\n   * Looks at all .endpoint.js files and adds them to the group they belong in\r\n   *\r\n   * @private\r\n   * @param {boolean} groupByFolder\r\n   * @memberof FunctionParser\r\n   */\r\n  private buildRestfulApi(groupByFolder: boolean) {\r\n    log('Restful Endpoints - Building...');\r\n\r\n    const apiFiles: string[] = glob.sync(`${this.rootPath}/**/*.endpoint.js`, {\r\n      cwd: this.rootPath,\r\n      ignore: './node_modules/**',\r\n    });\r\n\r\n    const app: Application = express();\r\n\r\n    const groupRouters: Map<string, express.Router> = new Map();\r\n\r\n    apiFiles.forEach((file: string) => {\r\n      const filePath: ParsedPath = parse(file);\r\n\r\n      const directories: Array<string> = filePath.dir.split('/');\r\n\r\n      const groupName: string = groupByFolder\r\n        ? directories[directories.length - 2] || ''\r\n        : directories[directories.length - 1] || '';\r\n\r\n      let router: Router | undefined = groupRouters.get(groupName);\r\n\r\n      if (!router) {\r\n        router = express.Router();\r\n\r\n        groupRouters.set(groupName, router);\r\n      }\r\n\r\n      try {\r\n        this.buildEndpoint(file, groupName, router);\r\n      } catch (e) {\r\n        throw new Error(\r\n          `Restful Endpoints - Failed to add the endpoint defined in ${file} to the ${groupName} Api.`,\r\n        );\r\n      }\r\n\r\n      app.use('/', router);\r\n\r\n      this.exports[groupName] = {\r\n        ...this.exports[groupName],\r\n        api: functions.https.onRequest(app),\r\n      };\r\n    });\r\n\r\n    log('Restful Endpoints - Built');\r\n  }\r\n\r\n  /**\r\n   * Parses a .endpoint.js file and sets the endpoint path on the provided router\r\n   *\r\n   * @private\r\n   * @param {string} file\r\n   * @param {express.Router} router\r\n   * @memberof FunctionParser\r\n   */\r\n  private buildEndpoint(\r\n    file: string,\r\n    groupName: string,\r\n    router: express.Router,\r\n  ) {\r\n    const filePath: ParsedPath = parse(file);\r\n\r\n    const endpoint: Endpoint = require(file).default as Endpoint;\r\n\r\n    const name: string =\r\n      endpoint.name || filePath.name.replace('.endpoint', '');\r\n\r\n    const { handler } = endpoint;\r\n\r\n    switch (endpoint.requestType) {\r\n      case RequestType.GET:\r\n        router.get(`/${name}`, handler);\r\n        break;\r\n\r\n      case RequestType.POST:\r\n        router.post(`/${name}`, handler);\r\n        break;\r\n\r\n      case RequestType.PUT:\r\n        router.put(`/${name}`, handler);\r\n        break;\r\n\r\n      case RequestType.DELETE:\r\n        router.delete(`/${name}`, handler);\r\n        break;\r\n\r\n      case RequestType.PATCH:\r\n        router.patch(`/${name}`, handler);\r\n        break;\r\n\r\n      default:\r\n        throw new Error(\r\n          `A unsupported RequestType was defined for a Endpoint.\\n\r\n          Please make sure that the Endpoint file exports a RequestType\r\n          using the constants in src/system/constants/requests.ts.\\n\r\n          **This value is required to add the Endpoint to the API**`,\r\n        );\r\n    }\r\n    log(\r\n      `Restful Endpoints - Added ${groupName}/${endpoint.requestType}:${name}`,\r\n    );\r\n  }\r\n}\r\n"],"names":["RequestType","Endpoint","name","requestType","handler","Error","Get","_Endpoint","undefined","GET","Post","_Endpoint2","POST","Put","_Endpoint3","PUT","Delete","_Endpoint4","DELETE","Patch","_Endpoint5","PATCH","log","console","FunctionParser","rootPath","exports","buildReactive","buildEndpoints","groupByFolder","buildReactiveFunctions","buildRestfulApi","glob","sync","this","cwd","ignore","forEach","file","filePath","parse","directories","dir","split","groupName","length","functionName","replace","process","env","FUNCTION_NAME","_this","require","apiFiles","app","express","groupRouters","Map","router","get","Router","set","_this2","buildEndpoint","e","use","api","functions","onRequest","endpoint","post","put","patch"],"mappings":"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"}